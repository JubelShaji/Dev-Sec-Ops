pipeline {
    agent none

    environment {
        DOCKER_REGISTRY = 'jubelshaji'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {

        stage('Building Containers') {
            agent {
                kubernetes {
                    yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
    - name: git
      image: alpine/git:latest
      command: ['cat']
      tty: true

    - name: kaniko-vote
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true

    - name: kaniko-seed
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true

    - name: kaniko-worker
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true

    - name: kaniko-result
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true

    - name: trivy
      image: jubelshaji/jenkins:trivy
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: trivy-cache
          mountPath: /root/.cache/trivy

    - name: kubectl
      image: bitnami/kubectl:latest
      command: ['sleep', 'infinity']
      tty: true

  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
        items:
            - key: .dockerconfigjson
              path: config.json
    - name: trivy-cache
      emptyDir: {}
"""
                }
            }

            stages {

                stage('Checkout Source') {
                    steps {
                        container('git') {
                            echo "üì¶ Checking out source code..."
                            git branch: 'main', url: 'https://github.com/JubelShaji/CI-CD-Voting-App.git'
                        }
                    }
                }

                stage('Build Images in Parallel') {
                    parallel {

                        stage('Build Vote Image') {
                            steps {
                                container('kaniko-vote') {
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///home/jenkins/agent/workspace/voteapp/vote \
                                        --dockerfile=Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:vote-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:vote-latest \
                                        --ignore-path=/product_uuid \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Seed Image') {
                            steps {
                                container('kaniko-seed') {
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///home/jenkins/agent/workspace/voteapp/seed-data \
                                        --dockerfile=Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:seed-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:seed-latest \
                                        --ignore-path=/product_uuid \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Worker Image') {
                            steps {
                                container('kaniko-worker') {
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///home/jenkins/agent/workspace/voteapp/worker \
                                        --dockerfile=Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:worker-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:worker-latest \
                                        --ignore-path=/product_uuid \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Result Image') {
                            steps {
                                container('kaniko-result') {
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///home/jenkins/agent/workspace/voteapp/result \
                                        --dockerfile=Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:result-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:result-latest \
                                        --ignore-path=/product_uuid \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                    } 
                }

                stage('Scan Images with Trivy') {
                    parallel {
                        stage('Scan Vote Image') {
                            steps {
                                container('trivy') {
                                    sh '''
                                    trivy image -f json -o trivy-vote.json --severity HIGH,CRITICAL --exit-code 1 jubelshaji/simple_vote_app:vote-${BUILD_NUMBER}
                                    trivy image -f html -o trivy-vote.html --severity HIGH,CRITICAL jubelshaji/simple_vote_app:vote-${BUILD_NUMBER}
                                    '''
                                    archiveArtifacts artifacts: 'trivy-vote.*', allowEmptyArchive: true
                                }
                            }
                        }

                        stage('Scan Seed Image') {
                            steps {
                                container('trivy') {
                                    sh '''
                                    trivy image -f json -o trivy-seed.json --severity HIGH,CRITICAL --exit-code 1 jubelshaji/simple_vote_app:seed-${BUILD_NUMBER}
                                    trivy image -f html -o trivy-seed.html --severity HIGH,CRITICAL jubelshaji/simple_vote_app:seed-${BUILD_NUMBER}
                                    '''
                                    archiveArtifacts artifacts: 'trivy-seed.*', allowEmptyArchive: true
                                }
                            }
                        }

                        stage('Scan Worker Image') {
                            steps {
                                container('trivy') {
                                    sh '''
                                    trivy image -f json -o trivy-worker.json --severity HIGH,CRITICAL --exit-code 1 jubelshaji/simple_vote_app:worker-${BUILD_NUMBER}
                                    trivy image -f html -o trivy-worker.html --severity HIGH,CRITICAL jubelshaji/simple_vote_app:worker-${BUILD_NUMBER}
                                    '''
                                    archiveArtifacts artifacts: 'trivy-worker.*', allowEmptyArchive: true
                                }
                            }
                        }

                        stage('Scan Result Image') {
                            steps {
                                container('trivy') {
                                    sh '''
                                    trivy image -f json -o trivy-result.json --severity HIGH,CRITICAL --exit-code 1 jubelshaji/simple_vote_app:result-${BUILD_NUMBER}
                                    trivy image -f html -o trivy-result.html --severity HIGH,CRITICAL jubelshaji/simple_vote_app:result-${BUILD_NUMBER}
                                    '''
                                    archiveArtifacts artifacts: 'trivy-result.*', allowEmptyArchive: true
                                }
                            }
                        }
                    }
                }


                stage('Update Kubernetes Manifests') {
                    steps {
                        git branch: 'main', url: 'https://github.com/JubelShaji/CI-CD-Voting-App.git'
                        sh """
                        sed -i 's|jubelshaji/simple_vote_app:vote-latest|jubelshaji/simple_vote_app:vote-${BUILD_NUMBER}|g' /home/jenkins/agent/workspace/Kubernetes/deployment/vote-deployment.yaml
                        sed -i 's|jubelshaji/simple_vote_app:worker-latest|jubelshaji/simple_vote_app:worker-${BUILD_NUMBER}|g' /home/jenkins/agent/workspace/Kubernetes/deployment/worker-deployment.yaml
                        sed -i 's|jubelshaji/simple_vote_app:result-latest|jubelshaji/simple_vote_app:result-${BUILD_NUMBER}|g' /home/jenkins/agent/workspace/Kubernetes/deployment/result-deployment.yaml
                        """
                    }
                }


                stage('Deploy to Kubernetes') {
                    steps {
                        container('kubectl') {
                            echo "üì¶ Applying Kubernetes manifests..."
                            sh 'kubectl apply -f /home/jenkins/agent/workspace/Kubernetes/deployment/'
                        }
                    }
                }

            } 
        } 

    } 

    post {
        success {
            echo 'üéâ All Docker images built, scanned & deployed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed. Check logs for Trivy or Kaniko reports.'
        }
    }
}
